# CodeT5 Java到C++代码翻译测试脚本使用说明

## 概述
这个测试脚本用于测试您微调过的CodeT5模型在Java到C++代码翻译任务上的性能。脚本会智能检查并管理必要的配置文件和tokenizer，只在首次运行时下载，之后从本地加载。**新增了CodeBLEU评估功能**，可以从AST结构和数据流两个维度评估代码翻译质量。

## 功能特性
- 支持加载.bin/.pt/.pth格式的模型文件
- 智能文件管理：自动检查并下载缺失的配置文件和tokenizer
- 本地缓存：首次下载后永久保存到模型目录，后续运行直接使用
- 智能识别不同的模型权重格式
- 包含8个Java到C++代码翻译测试样本，每个样本都有期望输出
- **CodeBLEU评估**：评估AST结构匹配度和数据流匹配度
- 可调整生成参数
- 清晰的测试结果展示和统计分析

## 使用方法

### 1. 基本测试（包含CodeBLEU评估）
```bash
python test_codet5_translation.py --model_path baseline_model/pytorch_model.bin
```

### 2. 禁用CodeBLEU评估（仅基础测试）
```bash
python test_codet5_translation.py --model_path baseline_model/pytorch_model.bin --disable_codebleu
```

### 3. 自定义参数
```bash
python test_codet5_translation.py \
    --model_path baseline_model/pytorch_model.bin \
    --device cuda \
    --max_length 500 \
    --top_k 10 \
    --top_p 0.95
```

## 参数说明
- `--model_path`: 模型文件路径（必需参数，支持.bin/.pt/.pth格式）
- `--device`: 运行设备，cuda或cpu（默认自动检测）
- `--max_length`: 最大生成长度（默认400）
- `--top_k`: Top-k采样参数（默认5）
- `--top_p`: Top-p采样参数（默认0.9）
- `--disable_codebleu`: 禁用CodeBLEU评估（默认启用）

## CodeBLEU评估说明

### 📊 评估指标
- **BLEU分数**: 基于n-gram的文本相似度
- **AST匹配度**: 抽象语法树结构的相似性，评估代码结构理解能力
- **Dataflow匹配度**: 数据流图的相似性，评估逻辑流程理解能力

### 🎯 评估等级
- **优秀** (≥0.8): 模型表现出色，翻译质量很高
- **良好** (0.6-0.8): 模型表现良好，翻译基本正确
- **一般** (0.4-0.6): 模型表现一般，需要改进
- **需要改进** (<0.4): 模型表现较差，需要重新训练或调优

### 🔍 评估意义
- **AST匹配度高**: 说明模型能正确理解和转换代码结构
- **Dataflow匹配度高**: 说明模型能正确理解变量依赖关系和逻辑流程
- **两者都高**: 表明模型既理解语法结构，又理解语义逻辑

## 测试内容
脚本包含以下Java到C++翻译测试样本：
1. Java简单加法函数转C++
2. Java递归阶乘函数转C++
3. Java斐波那契函数转C++
4. Java数组最大值函数转C++
5. Java冒泡排序函数转C++
6. Java字符串长度函数转C++
7. Java数组求和函数转C++
8. Java判断偶数函数转C++

每个测试样本都包含：
- **输入**: Java源代码
- **输出**: 模型生成的C++代码
- **期望**: 标准的C++参考答案
- **评估**: CodeBLEU各项指标分数

## 输出示例
```
================================================================================
开始CodeT5代码翻译测试 (Java -> C++)
✓ CodeBLEU评估已启用
================================================================================

测试 1/8: Java简单加法函数转C++
------------------------------------------------------------
输入: public int add(int a, int b) { return a + b; }
------------------------------------------------------------
输出: int add(int a, int b) { return a + b; }
------------------------------------------------------------
期望: int add(int a, int b) { return a + b; }
------------------------------------------------------------
📊 CodeBLEU评估:
   BLEU: 0.9876
   AST匹配: 0.9500
   Dataflow匹配: 0.9200
------------------------------------------------------------

...

================================================================================
测试完成!

📈 总体评估结果 (基于8个成功测试):
平均BLEU分数: 0.8543
平均AST匹配分数: 0.8125
平均Dataflow匹配分数: 0.7895
成功率: 8/8 (100.0%)

🎯 模型性能评估:
AST结构理解: 优秀 (0.8125)
数据流理解: 良好 (0.7895)
================================================================================
```

## 依赖要求
确保安装以下依赖：
```bash
pip install torch transformers sentencepiece protobuf
```

如果需要CodeBLEU评估，确保项目目录中有`codebleu`文件夹。

## 文件说明

### 您的模型文件
- **pytorch_model.bin** (850MB): 模型权重文件，包含训练后的所有神经网络参数

### 自动下载的辅助文件
脚本会自动检查并下载以下必要文件到模型目录：

#### 配置文件
- **config.json**: 模型架构配置，定义层数、注意力头数、隐藏层大小等结构参数

#### Tokenizer文件
- **tokenizer.json**: 主要的tokenizer配置文件
- **tokenizer_config.json**: tokenizer的配置参数和特殊token定义
- **vocab.json**: 词汇表，将每个token映射到唯一ID
- **merges.txt**: BPE(Byte Pair Encoding)合并规则
- **special_tokens_map.json**: 特殊token映射（如[PAD], [CLS], [SEP]等）

### 文件作用类比
- **pytorch_model.bin**: 相当于人的"记忆"，存储学到的所有知识
- **config.json**: 相当于人的"基因"，决定大脑结构和能力
- **tokenizer文件**: 相当于"字典"，负责理解和翻译文本

## 注意事项
1. 确保已安装所需依赖：transformers, torch, sentencepiece, protobuf
2. 如果使用GPU，确保CUDA环境正确配置
3. 首次运行会下载tokenizer和配置文件到模型目录，需要网络连接
4. 后续运行会自动使用本地缓存的文件，无需网络连接
5. 模型文件路径需要是完整路径或相对路径
6. 脚本会自动识别不同的模型权重格式并选择合适的加载方式
7. 如果模型加载失败，脚本会自动尝试备用加载方式
8. CodeBLEU评估需要相应的语言解析器支持

## 自定义测试
您可以修改`prepare_test_samples()`函数来添加自己的Java到C++翻译测试样本，格式如下：
```python
{
    'source': 'Java源代码',
    'gold': '期望的C++代码',
    'description': '测试描述'
}
```

示例：
```python
{
    'source': 'public class HelloWorld { public static void main(String[] args) { System.out.println("Hello World"); } }',
    'gold': '#include <iostream>\nusing namespace std;\nint main() { cout << "Hello World" << endl; return 0; }',
    'description': 'Java Hello World程序转C++'
}
``` 