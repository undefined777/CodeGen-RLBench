# ä¼˜åŒ–çš„PPOä»£ç ç”Ÿæˆè®­ç»ƒç¨‹åº

## æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäºPPOï¼ˆProximal Policy Optimizationï¼‰çš„ä»£ç ç”Ÿæˆå¼ºåŒ–å­¦ä¹ è®­ç»ƒç¨‹åºï¼Œä¸“é—¨ç”¨äºä»£ç ç¿»è¯‘ä»»åŠ¡ã€‚ç›¸æ¯”åŸå§‹ç‰ˆæœ¬ï¼Œæœ¬ç¨‹åºå…·æœ‰æ›´å¥½çš„ä»£ç ç»“æ„ã€è¯¦ç»†çš„æ³¨é‡Šã€å®Œå–„çš„é”™è¯¯å¤„ç†å’Œçµæ´»çš„é…ç½®ç®¡ç†ã€‚

## ä¸»è¦ç‰¹æ€§

### ğŸš€ æ ¸å¿ƒåŠŸèƒ½
- **å¤šè¯­è¨€æ”¯æŒ**ï¼šæ”¯æŒPythonã€Javaã€C++ã€Cã€JavaScriptã€PHPã€C#ç­‰ç¼–ç¨‹è¯­è¨€
- **PPOå¼ºåŒ–å­¦ä¹ **ï¼šåŸºäºç¼–è¯‘æˆåŠŸç‡å’Œä»£ç ç»“æ„çš„å¥–åŠ±è®¡ç®—
- **è‡ªé€‚åº”KLæ§åˆ¶**ï¼šåŠ¨æ€è°ƒæ•´ç­–ç•¥æ›´æ–°å¹…åº¦
- **åºåˆ—çº§åˆ«è®­ç»ƒ**ï¼šé’ˆå¯¹ä»£ç ç”Ÿæˆä»»åŠ¡çš„ç‰¹æ®Šä¼˜åŒ–

### ğŸ› ï¸ æŠ€æœ¯ä¼˜åŒ–
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¸…æ™°çš„ç±»ç»“æ„å’ŒèŒè´£åˆ†ç¦»
- **è¯¦ç»†æ—¥å¿—**ï¼šå®Œæ•´çš„è®­ç»ƒè¿‡ç¨‹è®°å½•å’Œç›‘æ§
- **é…ç½®ç®¡ç†**ï¼šæ”¯æŒJSONé…ç½®æ–‡ä»¶å’Œå‘½ä»¤è¡Œå‚æ•°
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œæ¢å¤æœºåˆ¶
- **ç±»å‹æç¤º**ï¼šå®Œæ•´çš„Pythonç±»å‹æ³¨è§£

### ğŸ“Š ç›‘æ§åŠŸèƒ½
- **å®æ—¶ç»Ÿè®¡**ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­çš„å„ç§æŒ‡æ ‡ç›‘æ§
- **ç»“æœä¿å­˜**ï¼šè‡ªåŠ¨ä¿å­˜æ¨¡å‹æ£€æŸ¥ç‚¹å’Œé¢„æµ‹ç»“æœ
- **æ€§èƒ½è¯„ä¼°**ï¼šå®šæœŸè¯„ä¼°æ¨¡å‹åœ¨è®­ç»ƒé›†å’Œæµ‹è¯•é›†ä¸Šçš„è¡¨ç°

## é¡¹ç›®ç»“æ„

```
CodeGen-RLBench/
â”œâ”€â”€ optimized_rl_trainer.py    # ä¼˜åŒ–çš„ä¸»è®­ç»ƒç¨‹åº
â”œâ”€â”€ run_training.py            # ç®€åŒ–çš„è®­ç»ƒå¯åŠ¨è„šæœ¬
â”œâ”€â”€ config.json               # é…ç½®æ–‡ä»¶ç¤ºä¾‹
â”œâ”€â”€ README_optimized.md       # æœ¬è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ rl_run.py                 # åŸå§‹è®­ç»ƒç¨‹åºï¼ˆå‚è€ƒï¼‰
â”œâ”€â”€ ppo.py                    # PPOç®—æ³•å®ç°
â”œâ”€â”€ reward.py                 # å¥–åŠ±è®¡ç®—æ¨¡å—
â”œâ”€â”€ model.py                  # æ¨¡å‹å®šä¹‰
â”œâ”€â”€ utils.py                  # å·¥å…·å‡½æ•°
â”œâ”€â”€ code_parser/              # ä»£ç è§£æå™¨
â”œâ”€â”€ codebleu/                 # CodeBLEUè¯„ä¼°å·¥å…·
â”œâ”€â”€ compiler/                 # ä»£ç ç¼–è¯‘å™¨
â””â”€â”€ code_prepro/              # ä»£ç é¢„å¤„ç†
```

## å®‰è£…å’Œè®¾ç½®

### 1. ç¯å¢ƒè¦æ±‚
```bash
# Python 3.8+
# CUDAæ”¯æŒï¼ˆæ¨èï¼‰
pip install -r requirements.txt
```

### 2. æ•°æ®å‡†å¤‡
ç¡®ä¿æ•°æ®ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š
```
data/
â”œâ”€â”€ Python-Java/
â”‚   â”œâ”€â”€ train-Python-Java-tok.py
â”‚   â”œâ”€â”€ train-Python-Java-tok.java
â”‚   â”œâ”€â”€ val-Python-Java-tok.py
â”‚   â”œâ”€â”€ val-Python-Java-tok.java
â”‚   â”œâ”€â”€ test-Python-Java-tok.py
â”‚   â””â”€â”€ test-Python-Java-tok.java
â””â”€â”€ Java-Python/
    â”œâ”€â”€ train-Java-Python-tok.java
    â”œâ”€â”€ train-Java-Python-tok.py
    â””â”€â”€ ...
```

### 3. æ¨¡å‹å‡†å¤‡
ä¸‹è½½é¢„è®­ç»ƒçš„CodeT5æ¨¡å‹ï¼š
```bash
# æ–¹æ³•1ï¼šä½¿ç”¨transformersè‡ªåŠ¨ä¸‹è½½
python -c "from transformers import T5ForConditionalGeneration; T5ForConditionalGeneration.from_pretrained('Salesforce/codet5-base')"

# æ–¹æ³•2ï¼šæ‰‹åŠ¨ä¸‹è½½å¹¶æ”¾ç½®åˆ°æŒ‡å®šç›®å½•
mkdir -p pretrained_models/codet5-base
# å°†æ¨¡å‹æ–‡ä»¶æ”¾ç½®åˆ°è¯¥ç›®å½•
```

## ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰

1. **ç¼–è¾‘é…ç½®æ–‡ä»¶**
```json
{
    "training_config": {
        "source_lang": "python",
        "target_lang": "java",
        "model_path": "./pretrained_models/codet5-base",
        "data_path": "./data",
        "output_path": "./outputs",
        "train_batch_size": 16,
        "train_epochs": 100,
        "learning_rate": 1e-5
    }
}
```

2. **å¯åŠ¨è®­ç»ƒ**
```bash
python run_training.py --config config.json
```

### æ–¹æ³•2ï¼šä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°

```bash
python run_training.py \
    --source_lang python \
    --target_lang java \
    --model_path ./pretrained_models/codet5-base \
    --data_path ./data \
    --output_path ./outputs \
    --train_batch_size 16 \
    --train_epochs 100 \
    --learning_rate 1e-5
```

### æ–¹æ³•3ï¼šç›´æ¥ä½¿ç”¨è®­ç»ƒå™¨ç±»

```python
from optimized_rl_trainer import CodeTranslationTrainer, TrainingConfig

# åˆ›å»ºé…ç½®
config = TrainingConfig(
    source_lang="python",
    target_lang="java",
    model_path="./pretrained_models/codet5-base",
    data_path="./data",
    output_path="./outputs",
    train_epochs=100
)

# åˆ›å»ºè®­ç»ƒå™¨å¹¶å¼€å§‹è®­ç»ƒ
trainer = CodeTranslationTrainer(config)
trainer.train()
```

## é…ç½®å‚æ•°è¯´æ˜

### å¿…éœ€å‚æ•°
- `source_lang`: æºä»£ç è¯­è¨€ï¼ˆpython, java, cpp, c, javascript, php, c_sharpï¼‰
- `target_lang`: ç›®æ ‡ä»£ç è¯­è¨€
- `model_path`: é¢„è®­ç»ƒæ¨¡å‹è·¯å¾„
- `data_path`: æ•°æ®ç›®å½•è·¯å¾„
- `output_path`: è¾“å‡ºç›®å½•è·¯å¾„

### è®­ç»ƒå‚æ•°
- `train_batch_size`: è®­ç»ƒæ‰¹æ¬¡å¤§å°ï¼ˆé»˜è®¤ï¼š16ï¼‰
- `test_batch_size`: æµ‹è¯•æ‰¹æ¬¡å¤§å°ï¼ˆé»˜è®¤ï¼š48ï¼‰
- `train_epochs`: è®­ç»ƒè½®æ•°ï¼ˆé»˜è®¤ï¼š1000000ï¼‰
- `learning_rate`: å­¦ä¹ ç‡ï¼ˆé»˜è®¤ï¼š1e-5ï¼‰
- `kl_coef`: KLç³»æ•°ï¼ˆé»˜è®¤ï¼š0.05ï¼‰
- `kl_target`: KLç›®æ ‡å€¼ï¼ˆé»˜è®¤ï¼š1.0ï¼‰
- `vf_coef`: ä»·å€¼å‡½æ•°ç³»æ•°ï¼ˆé»˜è®¤ï¼š1e-3ï¼‰

### ç”Ÿæˆå‚æ•°
- `action_space`: åŠ¨ä½œç©ºé—´å¤§å°/top_kï¼ˆé»˜è®¤ï¼š2ï¼‰
- `num_syn_samples`: æ¯è½®é‡‡æ ·æ¬¡æ•°ï¼ˆé»˜è®¤ï¼š5ï¼‰
- `max_source_length`: æœ€å¤§æºä»£ç é•¿åº¦ï¼ˆé»˜è®¤ï¼š400ï¼‰
- `max_target_length`: æœ€å¤§ç›®æ ‡ä»£ç é•¿åº¦ï¼ˆé»˜è®¤ï¼š400ï¼‰

## è¾“å‡ºæ–‡ä»¶

è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

```
outputs/
â”œâ”€â”€ logs/
â”‚   â””â”€â”€ training_1.log          # è®­ç»ƒæ—¥å¿—
â”œâ”€â”€ results/
â”‚   â””â”€â”€ python-java.csv         # è®­ç»ƒç»“æœç»Ÿè®¡
â”œâ”€â”€ checkpoints/
â”‚   â”œâ”€â”€ pytorch_model_ep0.bin   # æ¨¡å‹æ£€æŸ¥ç‚¹
â”‚   â”œâ”€â”€ train.model_ep0         # è®­ç»ƒé›†é¢„æµ‹ç»“æœ
â”‚   â”œâ”€â”€ train.gold_ep0          # è®­ç»ƒé›†æ ‡å‡†ç­”æ¡ˆ
â”‚   â”œâ”€â”€ test.model_ep0          # æµ‹è¯•é›†é¢„æµ‹ç»“æœ
â”‚   â””â”€â”€ test.gold_ep0           # æµ‹è¯•é›†æ ‡å‡†ç­”æ¡ˆ
```

## è®­ç»ƒç›‘æ§

### å®æ—¶æŒ‡æ ‡
- **ç¼–è¯‘æˆåŠŸç‡**ï¼šç”Ÿæˆä»£ç çš„ç¼–è¯‘æˆåŠŸæ¯”ä¾‹
- **è¯­æ³•é”™è¯¯æ•°**ï¼šä»£ç ä¸­çš„è¯­æ³•é”™è¯¯æ•°é‡
- **ASTåŒ¹é…åº¦**ï¼šæŠ½è±¡è¯­æ³•æ ‘åŒ¹é…ç¨‹åº¦
- **DFGåŒ¹é…åº¦**ï¼šæ•°æ®æµå›¾åŒ¹é…ç¨‹åº¦
- **KLæ•£åº¦**ï¼šç­–ç•¥åç¦»ç¨‹åº¦
- **å¥–åŠ±å€¼**ï¼šç»¼åˆå¥–åŠ±åˆ†æ•°

### æ—¥å¿—å†…å®¹
- è®­ç»ƒé…ç½®ä¿¡æ¯
- æ¯ä¸ªepochçš„è¯¦ç»†ç»Ÿè®¡
- é”™è¯¯å’Œè­¦å‘Šä¿¡æ¯
- æ¨¡å‹ä¿å­˜å’Œè¯„ä¼°ç»“æœ

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **CUDAå†…å­˜ä¸è¶³**
   ```bash
   # å‡å°‘æ‰¹æ¬¡å¤§å°
   --train_batch_size 8
   --test_batch_size 24
   ```

2. **æ•°æ®è·¯å¾„é”™è¯¯**
   ```bash
   # æ£€æŸ¥æ•°æ®ç›®å½•ç»“æ„
   ls -la data/Python-Java/
   ```

3. **æ¨¡å‹åŠ è½½å¤±è´¥**
   ```bash
   # æ£€æŸ¥æ¨¡å‹æ–‡ä»¶
   ls -la pretrained_models/codet5-base/
   ```

4. **ä¾èµ–åŒ…ç¼ºå¤±**
   ```bash
   # å®‰è£…ç¼ºå¤±çš„åŒ…
   pip install tree-sitter-java tree-sitter-python
   ```

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š
```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### ç¡¬ä»¶é…ç½®
- **GPU**: æ¨èä½¿ç”¨NVIDIA GPUï¼Œè‡³å°‘8GBæ˜¾å­˜
- **å†…å­˜**: å»ºè®®16GBä»¥ä¸Šç³»ç»Ÿå†…å­˜
- **å­˜å‚¨**: SSDç¡¬ç›˜ä»¥æé«˜æ•°æ®è¯»å–é€Ÿåº¦

### å‚æ•°è°ƒä¼˜
- **æ‰¹æ¬¡å¤§å°**: æ ¹æ®GPUæ˜¾å­˜è°ƒæ•´
- **å­¦ä¹ ç‡**: ä»1e-5å¼€å§‹ï¼Œæ ¹æ®æ”¶æ•›æƒ…å†µè°ƒæ•´
- **KLç³»æ•°**: æ§åˆ¶ç­–ç•¥æ›´æ–°å¹…åº¦ï¼Œé¿å…è¿‡åº¦åç¦»
- **é‡‡æ ·æ¬¡æ•°**: å¢åŠ é‡‡æ ·æ¬¡æ•°å¯èƒ½æé«˜ç¨³å®šæ€§

## æ‰©å±•åŠŸèƒ½

### è‡ªå®šä¹‰å¥–åŠ±å‡½æ•°
å¯ä»¥ä¿®æ”¹`reward.py`ä¸­çš„å¥–åŠ±è®¡ç®—é€»è¾‘ï¼š
```python
def custom_reward_function(code, target):
    # å®ç°è‡ªå®šä¹‰å¥–åŠ±é€»è¾‘
    return reward_score
```

### æ·»åŠ æ–°çš„ç¼–ç¨‹è¯­è¨€
1. åœ¨`code_prepro/lang_processors/`ä¸­æ·»åŠ è¯­è¨€å¤„ç†å™¨
2. åœ¨`code_parser/`ä¸­æ·»åŠ DFGå‡½æ•°
3. æ›´æ–°è¯­è¨€æ˜ å°„é…ç½®

### é›†æˆå…¶ä»–è¯„ä¼°æŒ‡æ ‡
å¯ä»¥åœ¨`codebleu/`ç›®å½•ä¸­æ·»åŠ æ–°çš„è¯„ä¼°æŒ‡æ ‡ã€‚

## è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäºåŸå§‹CodeGen-RLBenché¡¹ç›®ï¼Œè¯·å‚è€ƒåŸå§‹é¡¹ç›®çš„è®¸å¯è¯ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›é¡¹ç›®ï¼

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- æäº¤GitHub Issue
- å‘é€é‚®ä»¶è‡³é¡¹ç›®ç»´æŠ¤è€…

---

**æ³¨æ„**: è¿™æ˜¯ä¸€ä¸ªä¼˜åŒ–ç‰ˆæœ¬ï¼Œä¿æŒäº†ä¸åŸå§‹ç‰ˆæœ¬çš„åŠŸèƒ½å…¼å®¹æ€§ï¼ŒåŒæ—¶æä¾›äº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’Œä»£ç è´¨é‡ã€‚ 